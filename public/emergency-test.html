<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üö® EMERGENCY TEST - KL VARME Widget Cache Clear</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 40px;
            background: #ffe6e6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 40px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            border: 3px solid #ff4444;
        }
        h1 {
            color: #ff4444;
            margin-bottom: 20px;
            text-align: center;
        }
        .emergency {
            background: #ffeeee;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #ff4444;
        }
        .success {
            background: #eeffee;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #44ff44;
        }
        button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
        }
        button:hover {
            background: #cc3333;
        }
        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üö® EMERGENCY CACHE CLEAR TEST</h1>
        
        <div class="emergency">
            <h3>‚ö†Ô∏è PROBLEM</h3>
            <p>Widgeten viser fortsatt "KL VARME Assistant" i stedet for bare "KL VARME"</p>
            <p>Dette er et CACHE-problem. Denne siden tvinger nettleseren til √• laste ny versjon.</p>
        </div>
        
        <div class="success" id="success-message" style="display: none;">
            <h3>‚úÖ SUCCESS!</h3>
            <p>Widget lastet med riktig konfigurasjon!</p>
        </div>
        
        <div class="debug-info" id="debug-info">
            <strong>Debug Info:</strong><br>
            <div id="debug-content">Loading...</div>
        </div>
        
        <button onclick="forceReload()">üîÑ FORCE RELOAD WIDGET</button>
        <button onclick="clearCache()">üóëÔ∏è CLEAR ALL CACHE</button>
        <button onclick="testWidget()">üß™ TEST WIDGET</button>
        
        <h3>Sjekkliste:</h3>
        <ul>
            <li id="check-1">‚ùå Widget script lastet</li>
            <li id="check-2">‚ùå API config hentet</li>
            <li id="check-3">‚ùå Viser bare "KL VARME" (ikke Assistant)</li>
            <li id="check-4">‚ùå Chat fungerer</li>
        </ul>
    </div>

    <script>
        // EMERGENCY CACHE BUSTING
        const CACHE_BUST = Date.now() + Math.random();
        
        function updateDebugInfo() {
            const debugContent = document.getElementById('debug-content');
            debugContent.innerHTML = `
                Cache Bust: ${CACHE_BUST}<br>
                Widget Loaded: ${window.KLChatbot ? 'YES' : 'NO'}<br>
                Current URL: ${window.location.href}<br>
                Timestamp: ${new Date().toISOString()}<br>
                User Agent: ${navigator.userAgent.substring(0, 50)}...
            `;
        }
        
        function forceReload() {
            // Clear all possible caches
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(function(registrations) {
                    for(let registration of registrations) {
                        registration.unregister();
                    }
                });
            }
            
            // Force reload with cache clear
            window.location.reload(true);
        }
        
        function clearCache() {
            // Clear browser cache programmatically
            if ('caches' in window) {
                caches.keys().then(function(names) {
                    for (let name of names) {
                        caches.delete(name);
                    }
                });
            }
            
            // Clear localStorage
            localStorage.clear();
            sessionStorage.clear();
            
            alert('Cache cleared! Reloading page...');
            forceReload();
        }
        
        function testWidget() {
            if (window.KLChatbot) {
                window.KLChatbot.open();
                
                // Check title after a delay
                setTimeout(() => {
                    const title = document.querySelector('.klchat-title');
                    if (title) {
                        const titleText = title.textContent;
                        alert(`Widget title: "${titleText}"`);
                        
                        if (titleText === 'KL VARME') {
                            document.getElementById('success-message').style.display = 'block';
                            document.getElementById('check-3').innerHTML = '‚úÖ Viser bare "KL VARME" (ikke Assistant)';
                        } else {
                            alert(`ERROR: Title is "${titleText}" but should be "KL VARME"`);
                        }
                    }
                }, 1000);
            } else {
                alert('Widget not loaded yet!');
            }
        }
        
        // Update debug info every second
        setInterval(updateDebugInfo, 1000);
        updateDebugInfo();
        
        // Check widget loading
        function checkWidgetStatus() {
            if (window.KLChatbot) {
                document.getElementById('check-1').innerHTML = '‚úÖ Widget script lastet';
                
                // Test API
                fetch('https://klvarmechatbot.ailabben.no/api/config')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('check-2').innerHTML = '‚úÖ API config hentet';
                            console.log('API Config:', data.data);
                        }
                    });
            }
        }
        
        setInterval(checkWidgetStatus, 2000);
    </script>

    <!-- FORCE LOAD WIDGET WITH EXTREME CACHE BUSTING -->
    <script>
        console.log('üö® EMERGENCY: Loading widget with cache bust:', CACHE_BUST);
        
        // Remove any existing widget
        const existingWidgets = document.querySelectorAll('.klchat-widget');
        existingWidgets.forEach(w => w.remove());
        
        // Clear any existing initialization
        delete window.KLCHAT_INITIALIZED;
        delete window.KLChatbot;
        
        // Load fresh widget
        const script = document.createElement('script');
        script.src = `https://klvarmechatbot.ailabben.no/widget.js?v=${CACHE_BUST}&emergency=true&force=true`;
        script.onload = function() {
            console.log('‚úÖ Emergency widget loaded!');
            setTimeout(() => {
                if (window.KLChatbot) {
                    window.KLChatbot.init();
                    console.log('‚úÖ Widget initialized!');
                }
            }, 1000);
        };
        script.onerror = function() {
            console.error('‚ùå Failed to load emergency widget!');
        };
        
        document.head.appendChild(script);
    </script>
</body>
</html>
